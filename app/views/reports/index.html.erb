<div class="row">
  <div class="col-sm-6"><h1>Reports <% if params[:format] %> <span class="label label-default"><%= params[:format].titleize %></span><% end %></h1></div>
  <div class="col-sm-6">
    <%= link_to 'Add report', new_report_path, class: 'btn btn-success pull-right', style: 'margin-top: 28px;' %>
  </div>
</div>

<div class="row">
  <div class="col-sm-4">
    <%= link_to 'New', reports_path(params: { format: :new }), class: "label label-primary" %>
    <%= link_to 'In Process', reports_path(params:  { format: :in_process }), class: "label label-primary" %>
    <%= link_to 'Finished', reports_path(params: { format: :finished }), class: "label label-primary" %>
    <%= link_to 'All', reports_path(params: { format: :all }), class: "label label-default" %>
  </div>
</div>

<table class="table">
  <thead>
  <tr>
    <th>Info</th>
    <th>Status</th>
    <th>Progress</th>
    <th>Dates</th>
    <th>Note</th>
    <th>Files</th>
  </tr>
  </thead>
  <tbody>
  <% @reports.each do |report| %>
    <tr>
      <td>
        <%= report.format == 'tags' ? 'Publishers' : report.format.titleize %> for <%= report.input_amount %> <%= report.format != 'tags' ? 'usernames' : 'tags' %>
        <span class="glyphicon glyphicon-question-sign report-info" aria-hidden="true" data-container="body" data-toggle="popover" data-placement="right" data-html="true" data-content="Output data: <%= report.output_data.size > 0 ? report.output_data.join(', ') : 'No extra fields' %><br>Amounts: <%= report.amounts.inject([]){|ar, (k,v)| ar << "#{k.titleize}=#{v}"; ar}.join(' ') %>" data-trigger="hover"></span>
        <% if report.notify_email.present? %>
          <br>Notification to: <%= report.notify_email %>
        <% end %>
      </td>
      <td><span class="label label-<%= {'new' => 'info', 'in_process' => 'primary', 'finished' => 'success', 'stopped' => 'default'}[report.status] || 'warning' %>"><%= report.status.titleize %></span></td>
      <td>
        <div class="progress">
          <div class="progress-bar" role="progressbar" aria-valuenow="<%= report.progress || 0 %>" aria-valuemin="0" aria-valuemax="100" style="min-width: 2em; width: <%= report.progress || 0 %>%;">
            <%= report.progress || 0 %>% Complete
          </div>
        </div>
      </td>
      <td>
        <div>C: <%= report.created_at.strftime('%m/%d/%y %H:%M:%S') %></div>
        <div><%= "S: #{report.started_at.strftime('%m/%d/%y %H:%M:%S')}".html_safe if report.started_at %></div>
        <div><%= "F: #{report.finished_at.strftime('%m/%d/%y %H:%M:%S')}" if report.finished_at %></div>
      </td>
      <td><%= simple_format report.note %></td>
      <td>
        <div><%= link_to "Input data", report.original_input_url, target: :_blank %></div>
        <div><%= link_to 'Results file', report.result_data_url, target: :_blank if report.result_data.present? %></div>
      </td>
    </tr>
  <% end %>
  </tbody>
</table>
<%= paginate @reports %>